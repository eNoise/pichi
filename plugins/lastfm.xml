<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<PichiPlugin>
	<index>lastfm_playsong</index>
	<enabled>1</enabled>
	<name>Last.fm информация</name>
	<description>Возможность отображения индивидуальной информации с last.fm</description>
	<version>0.1</version>
        <code>
		<hook name="commands_show_help"><![CDATA[ 
			$help .= "!lastfm_setuser user - устанавливает ваш аккаунт на last.fm\n";
			$help .= "!lastfm - отображает то, что вы сейчас слушали\n";
		]]></hook>
		<hook name="commands_fetch"><![CDATA[ 
			if($command == 'lastfm')
			{
				$jid = $this->getJIDlast();
				$user = $this->getJIDinfo($jid, 'lastfm_user');
				if($user = $user['lastfm_user'])
				{
					$file = fopen("http://ws.audioscrobbler.com/1.0/user/{$user}/recenttracks.txt", "r");
					if($file)
					{
						$songs = array();
						while(!feof($file))
						{
							$song = fgets($file, 1024);
							$song = explode(',', $song);
							$songs[] = trim($song[1]);
						}
						fclose($file);
				
						$this->sendAnswer($this->getName($jid) . " только что слушал: " . $songs[0]);
					}
				}
			}
			else
			if($command == 'lastfm_setuser')
			{
				$jid = $this->getJIDlast();
				$w = $this->seperate($this->last_message);
				$this->setJIDinfo($jid, 'lastfm_user', $w[1]);
			}
		]]></hook>
        </code>
</PichiPlugin>
